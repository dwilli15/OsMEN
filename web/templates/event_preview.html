{% extends "base.html" %}

{% block title %}Event Preview - OsMEN{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Navbar -->
    {% include 'navbar.html' %}
    
    <!-- Main Content -->
    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold mb-6">Review Syllabus Events</h1>
        
        <!-- Course Info -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Course Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-gray-600">Course Code</p>
                    <p id="course-code" class="font-medium">Loading...</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Course Name</p>
                    <p id="course-name" class="font-medium">Loading...</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Instructor</p>
                    <p id="instructor" class="font-medium">Loading...</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Semester</p>
                    <p id="semester" class="font-medium">Loading...</p>
                </div>
            </div>
        </div>
        
        <!-- Event Actions -->
        <div class="bg-white rounded-lg shadow p-4 mb-6 flex justify-between items-center">
            <div class="space-x-2">
                <button onclick="selectAll(true)" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    Select All
                </button>
                <button onclick="selectAll(false)" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                    Deselect All
                </button>
            </div>
            <div>
                <button onclick="syncToCalendar()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                    Sync to Calendar
                </button>
            </div>
        </div>
        
        <!-- Events List -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b">
                <h2 class="text-xl font-semibold">Events (<span id="event-count">0</span>)</h2>
            </div>
            
            <div id="events-container" class="divide-y">
                <p class="text-gray-500 text-center py-8">Loading events...</p>
            </div>
        </div>
        
        <!-- Sync Progress -->
        <div id="sync-progress" class="hidden fixed bottom-4 right-4 bg-white rounded-lg shadow-lg p-6 max-w-md">
            <h3 class="font-semibold mb-2">Syncing to Calendar...</h3>
            <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
                <div id="progress-bar" class="bg-blue-600 h-4 rounded-full transition-all" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-sm text-gray-600">0 / 0 events synced</p>
        </div>
    </div>
</div>

<script>
let previewData = null;
let selectedEvents = new Set();

async function loadPreview() {
    const previewId = window.location.pathname.split('/').pop();
    
    try {
        const response = await fetch(`/api/syllabus/preview/${previewId}`);
        previewData = await response.json();
        
        // Display course info
        const course = previewData.course || {};
        document.getElementById('course-code').textContent = course.code || 'N/A';
        document.getElementById('course-name').textContent = course.name || 'N/A';
        document.getElementById('instructor').textContent = course.instructor?.name || 'N/A';
        document.getElementById('semester').textContent = `${course.semester?.term || 'N/A'} ${course.semester?.year || ''}`;
        
        // Display events
        const events = previewData.events || [];
        document.getElementById('event-count').textContent = events.length;
        
        const container = document.getElementById('events-container');
        
        if (events.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-8">No events found</p>';
            return;
        }
        
        container.innerHTML = events.map((event, index) => `
            <div class="p-4 hover:bg-gray-50">
                <div class="flex items-start space-x-4">
                    <input type="checkbox" id="event-${index}" checked 
                           onchange="toggleEvent(${index}, this.checked)"
                           class="mt-1 w-5 h-5 text-blue-600">
                    <div class="flex-1">
                        <div class="flex items-center justify-between">
                            <h3 class="font-medium">${event.title}</h3>
                            <span class="px-2 py-1 text-xs rounded ${
                                event.priority === 'high' ? 'bg-red-100 text-red-700' :
                                event.priority === 'medium' ? 'bg-yellow-100 text-yellow-700' :
                                'bg-green-100 text-green-700'
                            }">${event.priority || 'low'}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">${event.description || 'No description'}</p>
                        <div class="flex items-center space-x-4 mt-2 text-sm text-gray-500">
                            <span>üìÖ ${event.date || 'No date'}</span>
                            <span>üè∑Ô∏è ${event.type || 'event'}</span>
                            ${event.reminder?.enabled ? `<span>üîî ${event.reminder.advance_days} days before</span>` : ''}
                        </div>
                        <div class="mt-2">
                            <button onclick="editEvent(${index})" class="text-blue-600 hover:text-blue-800 text-sm">
                                Edit
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        // Select all by default
        events.forEach((_, index) => selectedEvents.add(index));
        
    } catch (error) {
        console.error('Error loading preview:', error);
        document.getElementById('events-container').innerHTML = 
            '<p class="text-red-500 text-center py-8">Error loading events</p>';
    }
}

function toggleEvent(index, checked) {
    if (checked) {
        selectedEvents.add(index);
    } else {
        selectedEvents.delete(index);
    }
}

function selectAll(checked) {
    const events = previewData?.events || [];
    events.forEach((_, index) => {
        const checkbox = document.getElementById(`event-${index}`);
        if (checkbox) {
            checkbox.checked = checked;
            toggleEvent(index, checked);
        }
    });
}

function editEvent(index) {
    // TODO: Implement event editing modal
    alert('Event editing coming soon!');
}

async function syncToCalendar() {
    const events = previewData?.events || [];
    const selectedEventsList = Array.from(selectedEvents).map(i => events[i]);
    
    if (selectedEventsList.length === 0) {
        alert('Please select at least one event to sync');
        return;
    }
    
    const progressDiv = document.getElementById('sync-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    
    progressDiv.classList.remove('hidden');
    progressBar.style.width = '0%';
    progressText.textContent = `0 / ${selectedEventsList.length} events synced`;
    
    try {
        const response = await fetch('/api/calendar/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({events: selectedEventsList})
        });
        
        const result = await response.json();
        
        progressBar.style.width = '100%';
        progressText.textContent = `${result.successful} / ${result.total} events synced`;
        
        setTimeout(() => {
            if (result.successful === result.total) {
                alert(`Success! ${result.successful} events synced to calendar.`);
                window.location.href = '/calendar';
            } else {
                alert(`Partial success: ${result.successful}/${result.total} events synced.\n${result.failed} events failed.`);
            }
            progressDiv.classList.add('hidden');
        }, 1500);
        
    } catch (error) {
        console.error('Error syncing:', error);
        progressDiv.classList.add('hidden');
        alert('Error syncing to calendar');
    }
}

window.addEventListener('DOMContentLoaded', loadPreview);
</script>
{% endblock %}
