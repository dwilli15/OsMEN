{% extends "base.html" %}

{% block title %}Calendar Setup - OsMEN{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Navbar -->
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">Calendar Setup</h1>
            <div>
                <a href="/dashboard" class="text-blue-100 hover:text-white mr-4">‚Üê Back to Dashboard</a>
                <a href="/logout" class="bg-blue-700 px-4 py-2 rounded hover:bg-blue-800">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto p-6 max-w-2xl">
        <div class="bg-white rounded-lg shadow">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-t-lg">
                <h2 class="text-2xl font-bold mb-2">Connect Your Calendars</h2>
                <p class="text-blue-100">Link your calendar providers to enable intelligent scheduling</p>
            </div>

            <!-- Status Messages -->
            {% if request.query_params.get('success') %}
            <div class="bg-green-50 border border-green-200 text-green-700 px-6 py-4 m-6 rounded-lg">
                ‚úÖ Calendar connected successfully! You can now upload syllabi and sync events.
            </div>
            {% endif %}

            {% if request.query_params.get('error') %}
            <div class="bg-red-50 border border-red-200 text-red-700 px-6 py-4 m-6 rounded-lg">
                ‚ùå Connection failed. Please try again or use an alternative calendar provider.
            </div>
            {% endif %}

            <!-- Calendar Options -->
            <div class="p-6 space-y-4">
                <!-- Google Calendar -->
                <div class="border-2 border-gray-200 rounded-lg p-6 hover:border-blue-400 transition cursor-pointer" id="google-card">
                    <div class="flex items-start">
                        <div class="flex-grow">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">üîµ Google Calendar</h3>
                            <p class="text-gray-600 text-sm mb-4">
                                Connect your Google Calendar to sync events from syllabi and enable smart scheduling.
                            </p>
                            <div class="space-y-2 text-sm text-gray-600">
                                <p>‚úì Automatic event creation from syllabi</p>
                                <p>‚úì Real-time scheduling optimization</p>
                                <p>‚úì Mobile app synchronization</p>
                            </div>
                        </div>
                        <button onclick="connectGoogle()" class="ml-4 bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600 transition font-semibold">
                            Connect
                        </button>
                    </div>
                </div>

                <!-- Outlook Calendar -->
                <div class="border-2 border-gray-200 rounded-lg p-6 hover:border-blue-400 transition cursor-pointer" id="outlook-card">
                    <div class="flex items-start">
                        <div class="flex-grow">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">üî∑ Microsoft Outlook</h3>
                            <p class="text-gray-600 text-sm mb-4">
                                Connect your Microsoft Outlook Calendar for Office 365 integration and enterprise features.
                            </p>
                            <div class="space-y-2 text-sm text-gray-600">
                                <p>‚úì Outlook integration with Teams</p>
                                <p>‚úì Enterprise security</p>
                                <p>‚úì Automatic meeting scheduling</p>
                            </div>
                        </div>
                        <button onclick="connectOutlook()" class="ml-4 bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600 transition font-semibold">
                            Connect
                        </button>
                    </div>
                </div>

                <!-- Connection Status -->
                <div id="status-container" class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200" style="display: none;">
                    <h4 class="font-semibold text-gray-800 mb-3">Connected Calendars:</h4>
                    <div id="status-content" class="space-y-2">
                        <p class="text-gray-600 text-sm">Loading status...</p>
                    </div>
                </div>
            </div>

            <!-- Security Notice -->
            <div class="bg-blue-50 border-t border-gray-200 px-6 py-4 rounded-b-lg">
                <p class="text-sm text-gray-700">
                    <strong>üîí Privacy:</strong> Your calendar data is only used to create events and generate schedules. 
                    We never store or share your personal calendar data with third parties.
                </p>
            </div>
        </div>

        <!-- Next Steps -->
        <div class="mt-6 bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">Next Steps</h3>
            <ol class="space-y-3 text-gray-700">
                <li class="flex">
                    <span class="text-blue-600 font-bold mr-3">1.</span>
                    <span>Connect at least one calendar provider above</span>
                </li>
                <li class="flex">
                    <span class="text-blue-600 font-bold mr-3">2.</span>
                    <span>Upload your course syllabus (PDF or Word document)</span>
                </li>
                <li class="flex">
                    <span class="text-blue-600 font-bold mr-3">3.</span>
                    <span>Review and confirm the parsed events</span>
                </li>
                <li class="flex">
                    <span class="text-blue-600 font-bold mr-3">4.</span>
                    <span>Let OsMEN generate your optimal study schedule</span>
                </li>
            </ol>
        </div>
    </div>
</div>

<script>
async function connectGoogle() {
    try {
        const response = await fetch('/api/calendar/google/oauth');
        const data = await response.json();
        if (data.auth_url) {
            window.location.href = data.auth_url;
        }
    } catch (error) {
        alert('Failed to initiate Google Calendar connection: ' + error);
    }
}

async function connectOutlook() {
    try {
        const response = await fetch('/api/calendar/outlook/oauth');
        const data = await response.json();
        if (data.auth_url) {
            window.location.href = data.auth_url;
        }
    } catch (error) {
        alert('Failed to initiate Outlook Calendar connection: ' + error);
    }
}

// Load calendar status on page load
async function loadCalendarStatus() {
    try {
        const response = await fetch('/api/calendar/status');
        const status = await response.json();
        
        const statusContainer = document.getElementById('status-container');
        const statusContent = document.getElementById('status-content');
        
        if (status.total > 0) {
            statusContainer.style.display = 'block';
            let html = '';
            if (status.google.connected) {
                html += '<p class="text-green-700">‚úÖ Google Calendar: Connected</p>';
            }
            if (status.outlook.connected) {
                html += '<p class="text-green-700">‚úÖ Outlook Calendar: Connected</p>';
            }
            statusContent.innerHTML = html;
        }
    } catch (error) {
        console.error('Failed to load calendar status:', error);
    }
}

// Load status on page load
document.addEventListener('DOMContentLoaded', loadCalendarStatus);
</script>
{% endblock %}
