<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - OsMEN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen" x-data="tasksApp()">
    <!-- Navigation -->
    <nav class="gradient-bg border-b border-slate-700 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="flex items-center space-x-3">
                        <i class="fas fa-brain text-2xl text-blue-400"></i>
                        <span class="text-xl font-bold">OsMEN</span>
                    </a>
                    <div class="hidden md:block ml-10">
                        <div class="flex items-baseline space-x-4">
                            <a href="/" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-slate-700">
                                <i class="fas fa-home mr-2"></i>Dashboard
                            </a>
                            <a href="/syllabus" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-slate-700">
                                <i class="fas fa-file-alt mr-2"></i>Syllabus
                            </a>
                            <a href="/calendar" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-slate-700">
                                <i class="fas fa-calendar mr-2"></i>Calendar
                            </a>
                            <a href="/tasks" class="px-3 py-2 rounded-md text-sm font-medium bg-slate-700">
                                <i class="fas fa-tasks mr-2"></i>Tasks
                            </a>
                            <a href="/agents" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-slate-700">
                                <i class="fas fa-robot mr-2"></i>Agents
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold mb-2">Task Manager</h1>
                <p class="text-slate-400">Manage your tasks and deadlines</p>
            </div>
            <button 
                @click="showAddTask = true"
                class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-semibold"
            >
                <i class="fas fa-plus mr-2"></i>Add Task
            </button>
        </div>

        <!-- Stats Row -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-slate-800 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-blue-400" x-text="stats.total || 0"></p>
                <p class="text-sm text-slate-400">Total Tasks</p>
            </div>
            <div class="bg-slate-800 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-amber-400" x-text="stats.pending || 0"></p>
                <p class="text-sm text-slate-400">Pending</p>
            </div>
            <div class="bg-slate-800 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-green-400" x-text="stats.completed || 0"></p>
                <p class="text-sm text-slate-400">Completed</p>
            </div>
            <div class="bg-slate-800 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-red-400" x-text="stats.overdue || 0"></p>
                <p class="text-sm text-slate-400">Overdue</p>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="flex space-x-2 mb-6 overflow-x-auto">
            <button 
                @click="filter = 'all'"
                :class="filter === 'all' ? 'bg-blue-600' : 'bg-slate-700 hover:bg-slate-600'"
                class="px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap"
            >
                All Tasks
            </button>
            <button 
                @click="filter = 'today'"
                :class="filter === 'today' ? 'bg-blue-600' : 'bg-slate-700 hover:bg-slate-600'"
                class="px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap"
            >
                Due Today
            </button>
            <button 
                @click="filter = 'upcoming'"
                :class="filter === 'upcoming' ? 'bg-blue-600' : 'bg-slate-700 hover:bg-slate-600'"
                class="px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap"
            >
                Upcoming
            </button>
            <button 
                @click="filter = 'overdue'"
                :class="filter === 'overdue' ? 'bg-blue-600' : 'bg-slate-700 hover:bg-slate-600'"
                class="px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap"
            >
                Overdue
            </button>
            <button 
                @click="filter = 'completed'"
                :class="filter === 'completed' ? 'bg-blue-600' : 'bg-slate-700 hover:bg-slate-600'"
                class="px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap"
            >
                Completed
            </button>
        </div>

        <!-- Task List -->
        <div class="bg-slate-800 rounded-xl">
            <div x-show="loading" class="p-8 text-center">
                <i class="fas fa-spinner fa-spin text-3xl text-blue-400"></i>
            </div>
            
            <div x-show="!loading && filteredTasks.length === 0" class="p-8 text-center text-slate-400">
                <i class="fas fa-inbox text-4xl mb-2"></i>
                <p>No tasks found</p>
            </div>

            <div x-show="!loading" class="divide-y divide-slate-700">
                <template x-for="task in filteredTasks" :key="task.id">
                    <div class="p-4 hover:bg-slate-700/50 transition-colors">
                        <div class="flex items-center space-x-4">
                            <button 
                                @click="toggleComplete(task)"
                                class="flex-shrink-0"
                            >
                                <i 
                                    :class="task.completed ? 'fas fa-check-circle text-green-500' : 'far fa-circle text-slate-500 hover:text-blue-400'"
                                    class="text-xl"
                                ></i>
                            </button>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center space-x-2">
                                    <p 
                                        class="font-medium truncate"
                                        :class="task.completed ? 'line-through text-slate-500' : ''"
                                        x-text="task.title"
                                    ></p>
                                    <span 
                                        class="text-xs px-2 py-0.5 rounded-full flex-shrink-0"
                                        :class="{
                                            'bg-red-500/20 text-red-400': task.priority === 'urgent' || task.priority === 'high',
                                            'bg-amber-500/20 text-amber-400': task.priority === 'medium',
                                            'bg-green-500/20 text-green-400': task.priority === 'low'
                                        }"
                                        x-text="task.priority"
                                    ></span>
                                </div>
                                <p class="text-sm text-slate-400 truncate" x-text="task.description"></p>
                            </div>
                            <div class="flex items-center space-x-4 flex-shrink-0">
                                <span 
                                    class="text-sm"
                                    :class="isOverdue(task.due_date) && !task.completed ? 'text-red-400' : 'text-slate-400'"
                                    x-text="formatDate(task.due_date)"
                                ></span>
                                <button 
                                    @click="deleteTask(task.id)"
                                    class="text-slate-500 hover:text-red-400"
                                >
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Add Task Modal -->
        <div 
            x-show="showAddTask" 
            class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
            @click.self="showAddTask = false"
        >
            <div class="bg-slate-800 rounded-xl p-6 w-full max-w-md mx-4">
                <h2 class="text-xl font-semibold mb-4">Add New Task</h2>
                <form @submit.prevent="addTask()">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Title</label>
                            <input 
                                type="text" 
                                x-model="newTask.title"
                                required
                                class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter task title"
                            >
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Description</label>
                            <textarea 
                                x-model="newTask.description"
                                class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter description"
                                rows="2"
                            ></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-slate-400 mb-1">Due Date</label>
                                <input 
                                    type="date" 
                                    x-model="newTask.due_date"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:ring-blue-500 focus:border-blue-500"
                                >
                            </div>
                            <div>
                                <label class="block text-sm text-slate-400 mb-1">Priority</label>
                                <select 
                                    x-model="newTask.priority"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:ring-blue-500 focus:border-blue-500"
                                >
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button 
                            type="button"
                            @click="showAddTask = false"
                            class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600"
                        >
                            Cancel
                        </button>
                        <button 
                            type="submit"
                            class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700"
                        >
                            Add Task
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        function tasksApp() {
            return {
                tasks: [],
                loading: true,
                filter: 'all',
                showAddTask: false,
                stats: {},
                newTask: {
                    title: '',
                    description: '',
                    due_date: '',
                    priority: 'medium'
                },

                async init() {
                    await this.loadTasks();
                },

                async loadTasks() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/tasks');
                        const data = await response.json();
                        this.tasks = data.tasks || [];
                        this.updateStats();
                    } catch (error) {
                        console.error('Error loading tasks:', error);
                    } finally {
                        this.loading = false;
                    }
                },

                updateStats() {
                    const now = new Date();
                    now.setHours(0, 0, 0, 0);
                    
                    this.stats = {
                        total: this.tasks.length,
                        completed: this.tasks.filter(t => t.completed).length,
                        pending: this.tasks.filter(t => !t.completed).length,
                        overdue: this.tasks.filter(t => !t.completed && this.isOverdue(t.due_date)).length
                    };
                },

                get filteredTasks() {
                    const now = new Date();
                    now.setHours(0, 0, 0, 0);
                    const endOfToday = new Date(now);
                    endOfToday.setHours(23, 59, 59, 999);

                    switch (this.filter) {
                        case 'today':
                            return this.tasks.filter(t => {
                                if (!t.due_date) return false;
                                const due = new Date(t.due_date);
                                return due >= now && due <= endOfToday && !t.completed;
                            });
                        case 'upcoming':
                            return this.tasks.filter(t => {
                                if (!t.due_date) return false;
                                const due = new Date(t.due_date);
                                return due > endOfToday && !t.completed;
                            });
                        case 'overdue':
                            return this.tasks.filter(t => !t.completed && this.isOverdue(t.due_date));
                        case 'completed':
                            return this.tasks.filter(t => t.completed);
                        default:
                            return this.tasks;
                    }
                },

                isOverdue(dateStr) {
                    if (!dateStr) return false;
                    const due = new Date(dateStr);
                    const now = new Date();
                    now.setHours(0, 0, 0, 0);
                    return due < now;
                },

                formatDate(dateStr) {
                    if (!dateStr) return 'No due date';
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                },

                async addTask() {
                    try {
                        const response = await fetch('/api/tasks', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newTask)
                        });
                        
                        if (response.ok) {
                            this.showAddTask = false;
                            this.newTask = { title: '', description: '', due_date: '', priority: 'medium' };
                            await this.loadTasks();
                        }
                    } catch (error) {
                        console.error('Error adding task:', error);
                    }
                },

                async toggleComplete(task) {
                    try {
                        await fetch(`/api/tasks/${task.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ completed: !task.completed })
                        });
                        task.completed = !task.completed;
                        this.updateStats();
                    } catch (error) {
                        console.error('Error updating task:', error);
                    }
                },

                async deleteTask(taskId) {
                    if (!confirm('Are you sure you want to delete this task?')) return;
                    
                    try {
                        await fetch(`/api/tasks/${taskId}`, { method: 'DELETE' });
                        this.tasks = this.tasks.filter(t => t.id !== taskId);
                        this.updateStats();
                    } catch (error) {
                        console.error('Error deleting task:', error);
                    }
                }
            };
        }
    </script>
</body>
</html>
