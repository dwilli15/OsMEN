name: Auto-Update Memory System

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  update-memory:
    # Only run if PR was merged
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Update memory.json
        run: |
          python3 << 'EOF'
          import json
          from datetime import datetime
          from pathlib import Path
          import os
          
          # Load current memory
          memory_file = Path(".copilot/memory.json")
          with open(memory_file, 'r') as f:
              memory = json.load(f)
          
          # Update last_updated
          memory["last_updated"] = datetime.utcnow().isoformat() + "Z"
          
          # Get PR information from environment
          pr_title = os.getenv("PR_TITLE", "Unknown PR")
          pr_number = os.getenv("PR_NUMBER", "0")
          pr_body = os.getenv("PR_BODY", "")
          
          # Add to conversation history (truncated)
          if "conversation_history" not in memory:
              memory["conversation_history"] = []
          
          memory["conversation_history"].append({
              "timestamp": datetime.utcnow().isoformat() + "Z",
              "type": "pr_merged",
              "pr_number": pr_number,
              "pr_title": pr_title,
              "summary": pr_body[:500] if pr_body else "No description"
          })
          
          # Keep only last 100 conversation entries in memory.json
          memory["conversation_history"] = memory["conversation_history"][-100:]
          
          # Update system state if PR indicates phase change
          if "phase" in pr_title.lower() or "v1." in pr_title.lower():
              # Extract version if present
              import re
              version_match = re.search(r'v?(\d+\.\d+\.\d+)', pr_title)
              if version_match:
                  memory["system_state"]["last_release"] = version_match.group(0)
          
          # Save updated memory
          with open(memory_file, 'w') as f:
              json.dump(memory, f, indent=2)
          
          print(f"Memory updated: PR #{pr_number} - {pr_title}")
          EOF
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BODY: ${{ github.event.pull_request.body }}
      
      - name: Update CONTEXT.md
        run: |
          python3 << 'EOF'
          from datetime import datetime
          from pathlib import Path
          import os
          
          context_file = Path("docs/CONTEXT.md")
          pr_title = os.getenv("PR_TITLE", "Unknown PR")
          pr_number = os.getenv("PR_NUMBER", "0")
          
          # Read current context
          content = context_file.read_text()
          
          # Update last updated date
          lines = content.split('\n')
          for i, line in enumerate(lines):
              if line.startswith("**Last Updated:**"):
                  lines[i] = f"**Last Updated:** {datetime.utcnow().strftime('%Y-%m-%d')}"
                  break
          
          # Add recent accomplishment
          recent_section_idx = None
          for i, line in enumerate(lines):
              if "### Recent Accomplishments" in line:
                  recent_section_idx = i
                  break
          
          if recent_section_idx:
              # Insert new accomplishment after the header
              new_accomplishment = f"- ✅ PR #{pr_number}: {pr_title} (merged {datetime.utcnow().strftime('%Y-%m-%d')})"
              lines.insert(recent_section_idx + 1, new_accomplishment)
          
          # Write back
          context_file.write_text('\n'.join(lines))
          
          print(f"CONTEXT.md updated with PR #{pr_number}")
          EOF
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
      
      - name: Update PROGRESS.md
        run: |
          python3 << 'EOF'
          from datetime import datetime
          from pathlib import Path
          import os
          
          progress_file = Path("PROGRESS.md")
          pr_title = os.getenv("PR_TITLE", "Unknown PR")
          pr_number = os.getenv("PR_NUMBER", "0")
          
          if progress_file.exists():
              content = progress_file.read_text()
              
              # Update last updated timestamp
              lines = content.split('\n')
              for i, line in enumerate(lines):
                  if line.startswith("**Last Updated:**"):
                      lines[i] = f"**Last Updated:** {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')} UTC"
                      break
              
              # Add to daily log
              today = datetime.utcnow().strftime("%Y-%m-%d")
              log_entry = f"\n### {today}\n**Focus:** PR #{pr_number} merged\n\n- Merged: {pr_title}\n"
              
              # Find daily log section and prepend
              daily_log_idx = None
              for i, line in enumerate(lines):
                  if "## Daily Progress Log" in line:
                      daily_log_idx = i
                      break
              
              if daily_log_idx:
                  # Insert after the header (skip one blank line)
                  lines.insert(daily_log_idx + 2, log_entry)
              
              progress_file.write_text('\n'.join(lines))
              print(f"PROGRESS.md updated")
          EOF
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .copilot/memory.json docs/CONTEXT.md PROGRESS.md
          git diff --cached --quiet || git commit -m "Auto-update: Memory system after PR #${{ github.event.pull_request.number }} merge"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          echo "✅ Memory system auto-updated after PR #${{ github.event.pull_request.number }} merge"
          echo "- Updated: memory.json, CONTEXT.md, PROGRESS.md"
          echo "- PR Title: ${{ github.event.pull_request.title }}"
