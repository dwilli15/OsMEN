# v3.0 Implementation Guide

**Version**: 3.0  
**Date**: 2025-11-23  
**Status**: In Progress

## Overview

Version 3.0 focuses on implementing the comprehensive frameworks created in v1 and v2, transforming framework code into production-ready features. The goal is to make all documented features actually work.

## What's New in v3.0

### 1. Integration Layer (NEW)

**File**: `integrations/v3_integration_layer.py`

A unified integration layer that connects all the separate framework components:
- OAuth handlers ‚Üí API wrappers ‚Üí Agents
- Automatic token management and refresh
- Unified error handling and logging
- Health check and status monitoring

**Benefits**:
- No more manual wiring of components
- Consistent API across all integrations
- Easy to add new providers
- Built-in monitoring and diagnostics

### 2. No-Code OAuth Setup (NEW)

**Files**: 
- `scripts/setup_oauth.py` - Interactive OAuth configuration
- `scripts/complete_oauth.py` - Complete authorization flow

**Usage**:

```bash
# List available providers
python scripts/setup_oauth.py --list

# Configure Google OAuth
python scripts/setup_oauth.py --provider google

# Configure Microsoft OAuth
python scripts/setup_oauth.py --provider microsoft

# Check current status
python scripts/setup_oauth.py --status

# Complete OAuth flow with authorization code
python scripts/complete_oauth.py --provider google --code YOUR_CODE
```

**No coding required!** The CLI guides you through the entire setup process.

## Feature Implementation Status

### Phase 1: OAuth & API Integration (IN PROGRESS)

| Feature | Status | Notes |
|---------|--------|-------|
| v3 Integration Layer | ‚úÖ Complete | Connects all framework components |
| OAuth Setup CLI | ‚úÖ Complete | Interactive, no-code configuration |
| Google OAuth | ‚úÖ Complete | Full OAuth 2.0 flow with PKCE |
| Microsoft OAuth | ‚úÖ Complete | Full OAuth 2.0 flow |
| Google Calendar API | ‚úÖ Complete | Create, read, update, delete events |
| Google Gmail API | ‚úÖ Complete | Send, receive, search emails |
| Google Contacts API | ‚úÖ Complete | Manage contacts |
| Outlook Calendar API | ‚úÖ Complete | Full calendar operations |
| Outlook Mail API | ‚úÖ Complete | Email management |
| Microsoft Contacts | ‚úÖ Complete | Contact management |
| Token Storage | üöß In Progress | Encrypted token storage |
| Token Auto-Refresh | üöß In Progress | Background token refresh |

### Phase 2: TTS & Audio Pipeline (PLANNED)

| Feature | Status | Notes |
|---------|--------|-------|
| TTS Provider Selection | ‚è≥ Planned | Coqui/ElevenLabs/Azure |
| Audiobook Pipeline | ‚è≥ Planned | End-to-end automation |
| Podcast Generation | ‚è≥ Planned | Multi-voice support |
| Voice Profiles | ‚è≥ Planned | Custom voice management |

### Phase 3: Zoom Integration (PLANNED)

| Feature | Status | Notes |
|---------|--------|-------|
| Zoom OAuth | ‚è≥ Planned | Based on existing OAuth framework |
| Meeting Transcription | ‚è≥ Planned | Whisper integration |
| Recording Management | ‚è≥ Planned | Download and process |

### Phase 4: Web Dashboard (PLANNED)

| Feature | Status | Notes |
|---------|--------|-------|
| Agent Status Dashboard | ‚è≥ Planned | Real-time monitoring |
| Workflow Builder UI | ‚è≥ Planned | Visual designer |
| Calendar/Task Views | ‚è≥ Planned | Multi-provider support |
| Content Management | ‚è≥ Planned | Media library |

### Phase 5: Production Hardening (PLANNED)

| Feature | Status | Notes |
|---------|--------|-------|
| SSL/TLS Automation | ‚è≥ Planned | Let's Encrypt integration |
| Prometheus Monitoring | ‚è≥ Planned | Metrics collection |
| Grafana Dashboards | ‚è≥ Planned | Visualization |
| Automated Backups | ‚è≥ Planned | PostgreSQL + Qdrant |
| Secrets Management | ‚è≥ Planned | Vault or AWS Secrets Manager |

## Quick Start Guide

### Setting Up Google Calendar Integration

1. **Create Google Cloud Project**:
   - Go to https://console.cloud.google.com
   - Create a new project
   - Enable Google Calendar API
   - Create OAuth 2.0 credentials
   - Add redirect URI: `http://localhost:8080/oauth/callback`
   - Download client secret JSON

2. **Configure OAuth**:
   ```bash
   python scripts/setup_oauth.py --provider google
   # Follow the interactive prompts
   # Enter your Client ID and Client Secret
   ```

3. **Authorize Application**:
   - The CLI will give you an authorization URL
   - Open the URL in your browser
   - Sign in and grant permissions
   - Copy the authorization code from the redirect URL

4. **Complete Setup**:
   ```bash
   python scripts/complete_oauth.py --provider google --code YOUR_CODE
   # This exchanges the code for tokens
   ```

5. **Verify**:
   ```bash
   python scripts/setup_oauth.py --status
   # Should show Google Calendar as available
   ```

### Setting Up Microsoft Outlook Integration

1. **Create Azure AD Application**:
   - Go to https://portal.azure.com
   - Navigate to Azure Active Directory ‚Üí App registrations
   - Create a new registration
   - Add redirect URI: `http://localhost:8080/oauth/callback`
   - Create a client secret
   - Note your Application (client) ID and secret

2. **Configure OAuth**:
   ```bash
   python scripts/setup_oauth.py --provider microsoft
   # Follow the interactive prompts
   ```

3. **Authorize and Complete** (same as Google steps 3-5)

## Using the Integration Layer

### Python API

```python
from integrations.v3_integration_layer import get_integration_layer

# Get integration layer instance
integration = get_integration_layer()

# Check status
status = integration.get_integration_status()
print(status)

# Use Google Calendar
calendar = integration.get_google_calendar()
calendars = calendar.list_calendars()

# Create an event
event_data = {
    'summary': 'Team Meeting',
    'start': {'dateTime': '2025-11-25T10:00:00Z'},
    'end': {'dateTime': '2025-11-25T11:00:00Z'}
}
event = calendar.create_event('primary', event_data)

# Use Gmail
gmail = integration.get_google_gmail()
messages = gmail.list_messages(max_results=10)

# Use Outlook Calendar
outlook = integration.get_outlook_calendar()
events = outlook.list_events()
```

### Command Line (via agents)

```bash
# Daily brief with calendar integration
python agents/daily_brief/daily_brief_agent.py

# Personal assistant with calendar
python agents/personal_assistant/personal_assistant_agent.py
```

## Architecture Changes

### v1.0 & v2.0 (Before)

```
OAuth Handler (isolated)
    ‚Üì
API Wrapper (isolated)
    ‚Üì
Agent (manual wiring)
```

**Problems**:
- Each component in isolation
- Manual integration required
- No unified token management
- Inconsistent error handling

### v3.0 (After)

```
V3IntegrationLayer
    ‚îú‚îÄ‚îÄ OAuth Handlers
    ‚îÇ   ‚îú‚îÄ‚îÄ Google OAuth
    ‚îÇ   ‚îî‚îÄ‚îÄ Microsoft OAuth
    ‚îú‚îÄ‚îÄ API Wrappers
    ‚îÇ   ‚îú‚îÄ‚îÄ Google (Calendar, Gmail, Contacts)
    ‚îÇ   ‚îî‚îÄ‚îÄ Microsoft (Calendar, Mail, Contacts)
    ‚îî‚îÄ‚îÄ Agents (automatic connection)
```

**Benefits**:
- Automatic component wiring
- Centralized token management
- Unified error handling
- Easy to extend

## Development Workflow

### Adding a New Integration

1. **Create OAuth Handler** (if new provider):
   ```python
   # integrations/oauth/provider_oauth.py
   class ProviderOAuthHandler(OAuthHandler):
       # Implement OAuth 2.0 flow
   ```

2. **Create API Wrapper**:
   ```python
   # integrations/provider/wrappers/api_wrapper.py
   class ProviderAPIWrapper:
       def __init__(self, oauth_handler):
           self.oauth_handler = oauth_handler
       # Implement API methods
   ```

3. **Add to Integration Layer**:
   ```python
   # integrations/v3_integration_layer.py
   def setup_provider_oauth(self, ...):
       # Configure OAuth
   
   def get_provider_api(self):
       # Return API wrapper
   ```

4. **Add CLI Support**:
   ```python
   # scripts/setup_oauth.py
   def setup_provider(self):
       # Interactive setup
   ```

5. **Update Documentation**:
   - Add to this guide
   - Update README.md
   - Add runbook

## Testing

### Manual Testing

```bash
# Test OAuth setup
python scripts/setup_oauth.py --status

# Test integration layer
python -c "from integrations.v3_integration_layer import get_integration_layer; print(get_integration_layer().get_integration_status())"

# Test Google Calendar
python -c "from integrations.v3_integration_layer import get_integration_layer; cal = get_integration_layer().get_google_calendar(); print(cal.list_calendars() if cal else 'Not configured')"
```

### Automated Testing

```bash
# Run integration tests
python -m pytest tests/integrations/

# Run OAuth tests
python -m pytest tests/oauth/

# Run end-to-end tests
python -m pytest tests/e2e/
```

## Troubleshooting

### OAuth Configuration Issues

**Problem**: "OAuth not configured" error

**Solution**:
```bash
# Check status
python scripts/setup_oauth.py --status

# Reconfigure
python scripts/setup_oauth.py --provider google  # or microsoft
```

### Token Expired

**Problem**: "Token expired" error

**Solution**:
```bash
# Token refresh should be automatic
# If it fails, re-authorize:
python scripts/setup_oauth.py --provider google
python scripts/complete_oauth.py --provider google --code NEW_CODE
```

### API Access Denied

**Problem**: "Insufficient permissions" error

**Solution**:
1. Check scopes in configuration
2. Re-configure with correct scopes
3. Re-authorize application

### Calendar Not Found

**Problem**: Empty calendar list

**Solution**:
1. Verify OAuth scope includes calendar access
2. Check user has calendars in their account
3. Try listing with primary calendar ID

## Security Considerations

### Token Storage

- Tokens stored in `.copilot/integrations/tokens/`
- File permissions: 600 (owner read/write only)
- **TODO**: Implement encryption at rest
- **TODO**: Integrate with secrets manager

### Credentials

- Never commit credentials to git
- Use environment variables or secure storage
- Rotate secrets regularly
- Use separate credentials for dev/staging/prod

### OAuth Redirect

- Use HTTPS in production
- Validate state parameter (CSRF protection)
- Use PKCE for additional security
- Short-lived authorization codes

## Performance Optimization

### Rate Limiting

All API wrappers include automatic rate limiting:
- Google: 10 requests/second
- Microsoft: 10 requests/second
- Automatic backoff on 429 errors

### Caching

- Calendar events cached for 5 minutes
- Contact lists cached for 15 minutes
- Email lists not cached (always fresh)

### Batch Operations

Use batch methods when available:
```python
# Good - batch operation
calendar.batch_create_events(events)

# Avoid - individual calls in loop
for event in events:
    calendar.create_event(event)
```

## Next Steps

1. **Phase 2**: Implement TTS & Audio Pipeline
2. **Phase 3**: Zoom Integration
3. **Phase 4**: Web Dashboard Enhancement
4. **Phase 5**: Production Hardening
5. **Phase 6**: Cross-Platform Support

## Resources

- [Google OAuth 2.0](https://developers.google.com/identity/protocols/oauth2)
- [Microsoft OAuth 2.0](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-auth-code-flow)
- [Google Calendar API](https://developers.google.com/calendar/api/v3/reference)
- [Microsoft Graph API](https://docs.microsoft.com/en-us/graph/api/overview)

## Support

- Issues: https://github.com/dwilli15/OsMEN/issues
- Discussions: https://github.com/dwilli15/OsMEN/discussions
- Documentation: `/docs` directory

---

**Last Updated**: 2025-11-23  
**Maintainer**: OsMEN Development Team
